<!DOCTYPE html>
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!-- if you plan to use this example, download drag dealer from
    https://code.google.com/p/dragdealer/ instead of hotlinking it like this -->
    <script src='http://dragdealer.googlecode.com/svn/tags/0.9.5/dragdealer.js'></script>
    <script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.6/mapbox.js'></script>
    <link href='/static/css/mapbox.css' rel='stylesheet' />
    <link href='/static/css/map.css' rel='stylesheet' type='text/css' />
    <link href='/static/css/style.css' rel='stylesheet' type='text/css' />
</head>

<body>
    <div id='map'></div>
    <div id='logo'>Urban Strata</div>

    <script>
    // Create the map after retrieving the features.json
    $.getJSON("static/features.json", function(features){
        // Create map
        var map = mapbox.map('map');
        map.addLayer(mapbox.layer().id('gavinh.UrbanStrata'));

        // Create and add marker layer
        var markerLayer = mapbox.markers.layer().features(features);

        // Replace the markerLayer factory function
        markerLayer.factory(function(m) {
            // Create a marker using the simplestyle factory
            var elem = mapbox.markers.simplestyle_factory(m);

            // Add function that centers marker on click
            MM.addEvent(elem, 'click', function(e) {
                var shadow = jQuery('<div id="shadow" />');
                shadow.click(function(){
                    $('#shadow').remove();
                    $('#overlay').remove();
                });
                shadow.appendTo(document.body);
                // Fuck javascript. Caching and autoplay attr mess up pausing.
                var overlay = jQuery('<div id="overlay"><video id="myVideo" autoplay width="640" height="360" controls /></div>');
                overlay.appendTo(document.body);
                var source = "http://ec2-184-73-119-136.compute-1.amazonaws.com/static/vid/" + m.properties.video + ".webm";
                $("#myVideo").attr("src", source);
                map.ease.location({
                    lat: m.geometry.coordinates[1],
                    lon: m.geometry.coordinates[0]
                }).zoom(map.zoom()).optimal();
            }); 
            return elem;
        }); 

        // Add the markers layer
        var interaction = mapbox.markers.interaction(markerLayer);
        map.addLayer(markerLayer);

        // Set a custom formatter for tooltips
        // Provide a function that returns html to be used in tooltip
        interaction.formatter(function(feature) {
            var o = 
            '<h2>' + feature.properties.name + '</h2>' +
            '<h3>' + feature.properties.address + '</h3>' + 
            '<img class="descriptionImg" src="' + feature.properties.image + '"/>' + 
            feature.properties.desc;

            return o;
        });

        // Set iniital map center and zoom level
        map.centerzoom({
            lat: 42.361711128482284,
            lon: -71.06155264816285
        }, 15);
        map.setZoomRange(15,17);
        map.ui.zoomer.add();
    });
    </script>
</body>
</html>
